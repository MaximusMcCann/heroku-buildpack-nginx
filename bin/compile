#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

# config
NGINX_VERSION="1.7.3"
PCRE_VERSION="8.35"
S3_BUCKET="essh-heroku-buildpack-nginx"

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

# s3 packages
NGINX_PACKAGE="http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz"

# vendor directories
VENDORED_NGINX=$(mktemp -d -t nginx.XXXXXX)
echo "Vendored Nginx: $VENDORED_NGINX"

# download and upack packages
echo "-----> Fetching nginx binaries"
curl $NGINX_PACKAGE -s -o - | tar zxvf - -C $VENDORED_NGINX

curl ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-${PCRE_VERSION}.tar.gz -o pcre.tgz
tar xzf pcre.tgz

# build and package nginx for heroku
vulcan build -v -n nginx -o $VENDORED_NGINX/nginx-${NGINX_VERSION}.tgz -c "cd nginx-${NGINX_VERSION} && ./configure --prefix=/app/vendor/nginx --with-pcre=../pcre-${PCRE_VERSION} --with-http_stub_status_module --with-http_gzip_static_module --with-http_realip_module && make install"


# vendor nginx into the slug
echo "-----> Vendoring nginx $NGINX_VERSION"
mkdir -p "$BUILD_DIR/bin"
cp "$VENDORED_NGINX/sbin/nginx" "$BUILD_DIR/bin/nginx"

# build a startup script
cat <<EOF >"$BUILD_DIR/bin/start_nginx"
#!/usr/bin/env bash
erb conf/nginx.conf.erb > conf/nginx.conf
mkdir -p logs
touch logs/access.log logs/error.log
(tail -qF -n 0 --pid=\$\$ logs/*.log &)
exec bin/nginx -p .
EOF
chmod +x "$BUILD_DIR/bin/start_nginx"
